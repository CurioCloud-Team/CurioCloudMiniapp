<view class="page">
  <!-- 装饰背景 -->
  <view class="bg-decoration">
    <view class="orb orb-1"></view>
    <view class="orb orb-2"></view>
    <view class="orb orb-3"></view>
  </view>

  <!-- TDesign 导航栏 -->
  <t-navbar 
    title="分析报告" 
    fixed="{{true}}" 
    left-arrow 
    bind:go-back="goBack"
    class="custom-navbar" 
  />

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-state">
    <t-loading theme="circular" size="80rpx" text="加载报告中..." />
  </view>

  <!-- 报告内容 -->
  <view wx:elif="{{report}}" class="content-area">
    <!-- 报告头部卡片 -->
    <view class="hero-card">
      <view class="hero-bg"></view>
      <view class="hero-content">
        <view class="hero-icon">
          <t-icon name="chart-pie" size="56rpx" color="#fff" />
        </view>
        <text class="hero-title">{{report.title || '分析报告'}}</text>
        <view class="hero-meta">
          <view class="meta-item">
            <t-icon name="time" size="28rpx" color="rgba(255,255,255,0.8)" />
            <text>{{report.created_at}}</text>
          </view>
          <view class="meta-item">
            <t-icon name="user" size="28rpx" color="rgba(255,255,255,0.8)" />
            <text>{{report.student_count}} 人</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 成绩概览 -->
    <view class="section-card">
      <view class="section-header">
        <t-icon name="chart-bar" size="40rpx" color="#667eea" />
        <text class="section-title">成绩概览</text>
      </view>

      <view class="stats-grid">
        <view class="stat-item stat-avg">
          <view class="stat-icon">
            <t-icon name="trending-up" size="36rpx" color="#667eea" />
          </view>
          <text class="stat-value">{{report.summary.average_score}}</text>
          <text class="stat-label">平均分</text>
        </view>
        <view class="stat-item stat-high">
          <view class="stat-icon">
            <t-icon name="arrow-up" size="36rpx" color="#10b981" />
          </view>
          <text class="stat-value">{{report.summary.highest_score}}</text>
          <text class="stat-label">最高分</text>
        </view>
        <view class="stat-item stat-low">
          <view class="stat-icon">
            <t-icon name="arrow-down" size="36rpx" color="#f59e0b" />
          </view>
          <text class="stat-value">{{report.summary.lowest_score}}</text>
          <text class="stat-label">最低分</text>
        </view>
        <view class="stat-item stat-pass">
          <view class="stat-icon">
            <t-icon name="check-circle" size="36rpx" color="#8b5cf6" />
          </view>
          <text class="stat-value">{{report.summary.pass_rate}}%</text>
          <text class="stat-label">及格率</text>
        </view>
      </view>

      <!-- 分数段分布 -->
      <view class="distribution-section">
        <text class="distribution-title">分数段分布</text>
        <view class="distribution-list">
          <block wx:for="{{report.summary.distribution}}" wx:key="range">
            <view class="distribution-item">
              <text class="range-label">{{item.range}}</text>
              <view class="bar-container">
                <view class="bar-fill" style="width: {{item.count * 20}}%;"></view>
              </view>
              <text class="count-label">{{item.count}} 人</text>
            </view>
          </block>
        </view>
      </view>
    </view>

    <!-- 洞察分析 -->
    <view class="section-card" wx:if="{{report.insights && report.insights.length}}">
      <view class="section-header">
        <t-icon name="lightbulb" size="40rpx" color="#f59e0b" />
        <text class="section-title">洞察分析</text>
      </view>

      <view class="insights-list">
        <block wx:for="{{report.insights}}" wx:key="title">
          <view class="insight-card">
            <view class="insight-header">
              <view class="insight-number">{{index + 1}}</view>
              <text class="insight-title">{{item.title}}</text>
            </view>
            <text class="insight-desc">{{item.description}}</text>
            <view class="suggestions" wx:if="{{item.suggestions && item.suggestions.length}}">
              <text class="suggestions-label">建议</text>
              <view class="suggestion-tags">
                <t-tag 
                  wx:for="{{item.suggestions}}" 
                  wx:for-item="suggestion" 
                  wx:key="index"
                  variant="light"
                  theme="primary"
                  size="small"
                  class="suggestion-tag"
                >{{suggestion}}</t-tag>
              </view>
            </view>
          </view>
        </block>
      </view>
    </view>

    <!-- 推荐行动 -->
    <view class="section-card" wx:if="{{report.recommended_actions && report.recommended_actions.length}}">
      <view class="section-header">
        <t-icon name="task" size="40rpx" color="#10b981" />
        <text class="section-title">推荐行动</text>
      </view>

      <view class="actions-list">
        <block wx:for="{{report.recommended_actions}}" wx:key="index">
          <view class="action-item">
            <view class="action-icon">
              <t-icon name="check" size="28rpx" color="#10b981" />
            </view>
            <text class="action-text">{{item}}</text>
          </view>
        </block>
      </view>
    </view>

    <!-- 底部操作 -->
    <view class="bottom-actions">
      <t-button 
        theme="primary" 
        size="large" 
        block 
        bindtap="goBack"
        class="back-btn-primary"
      >
        <t-icon name="chevron-left" size="36rpx" />
        返回
      </t-button>
    </view>
  </view>

  <!-- 空状态 -->
  <view wx:else class="empty-state">
    <view class="empty-icon">
      <t-icon name="file-unknown" size="120rpx" color="#cbd5e1" />
    </view>
    <text class="empty-title">暂无报告数据</text>
    <t-button theme="primary" variant="outline" bindtap="goBack">返回</t-button>
  </view>
</view>
